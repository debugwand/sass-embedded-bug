# PoC of failing imports using webpack 5 / css-loader / sass-loader / sass-embedded

In certain conditions, a package is not resolved successfully using the `sass-embedded` implementation where it works in the `sass` implementation:

* a not necessarily related package's sass file has been imported twice
* a package has been installed as a dependency of a package instead of at the root `node_modules` folder
* this nested package's scss file is imported after the imports happen for a second time

There is a difference in what is being set for the variable `prev` (at point of https://github.com/webpack-contrib/sass-loader/blob/master/src/utils.js#L711) when running `sass` vs `sass-embedded` - see [context-when-builds.txt](context-when-builds.txt) and [context-when-fails.txt](context-when-fails.txt) for a comparison. These were generated by logging out the values of `prev` and `originalUrl` close to the start of the `getWebpackImporter` function (before the call to `resolve`)

## Running the PoC

Clone this repo, cd into the directory and run the following:
* `npm install`
* `npm run build`

You should see an error like:
```
ERROR in ./src/main.scss (./src/main.scss.webpack[javascript/auto]!=!./node_modules/css-loader/dist/cjs.js??ruleSet[1].rules[0].use[1]!./node_modules/sass-loader/dist/cjs.js??ruleSet[1].rules[0].use[2]!./src/main.scss)
Module build failed (from ./node_modules/sass-loader/dist/cjs.js):
Can't find stylesheet to import.
```

While I discovered this issue using packages that had been installed from npm, in order to get a working demo without a lot of other distracting code, I've replaced these (large, noisy) dependency packages with minimal dependencies that have been mocked up in the `@somenamespace` folder. This will build either in situ or by moving it inside `node_modules`.

## Isolating the issue

Either of the following actions will result in the build working:

### No repeated dependency
Commenting out `@import '@somenamespace/dep0/main';` in either `@somenamespace/depx/main.scss` or `@somenamespace/depy/main.scss` will result in the build succeeding.

### webpack.config.js
If you change `implementation: require("sass-embedded"),` to `implementation: require("sass"),` you will see that the CSS successfully builds

## Packages in use
* webpack 5.91.0
* webpack-cli 5.1.4
* mini-css-extract-plugin 2.9.0
* css-loader 7.1.2
* sass-loader 14.2.1
* sass 1.77.2
* sass-embedded 1.77.2
